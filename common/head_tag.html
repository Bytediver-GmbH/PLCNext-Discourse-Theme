<!-- PLCNext Community Header Theme -->
<meta name="theme-name" content="PLCNext Community Header Theme">
<meta name="theme-version" content="2.0.0">

<!-- PLCNext Header Template -->
<template id="plcnext-header-template">
  <div class="menu-wrapper" data-menu-wrapper>
    <header class="header-main">
      <div class="header-container">
        <div class="mobile-nav-left">
          <button class="btn btn-flat btn-sidebar-toggle no-text btn-icon" title="Toggle Sidebar">
            <svg class="fa d-icon d-icon-bars svg-icon svg-node" aria-hidden="true"><use href="#bars"></use></svg>
          </button>
        </div>

        <div class="logo-section">
          <a href="https://www.plcnext-community.net" class="logo">
            <img src="https://www.plcnext-community.net/app/themes/plcnextcommunity/static/images/logo-plc-next.svg" alt="PLCnext Community" class="logo-image">
          </a>
        </div>

        <nav class="main-navigation">
          <ul class="nav-menu">
            <li class="nav-item">
              <a href="https://www.plcnext-community.net/infocenter/news" class="nav-link">News & Articles</a>
            </li>
            <li class="nav-item">
              <a href="https://www.plcnext-community.net/about-plcnext-technology" class="nav-link">About PLCnext Technology</a>
            </li>
            <li class="nav-item">
              <a href="https://www.plcnext-community.net/learning" class="nav-link">Learning</a>
            </li>
            <li class="nav-item">
              <a href="https://www.plcnext-community.net/makers-blog" class="nav-link">Maker's Blog</a>
            </li>
            <li class="nav-item">
              <a href="/" class="nav-link">Forum</a>
            </li>
            <li class="nav-item">
              <a href="https://www.plcnext-community.net/getting-started-with-plcnext-technology/#learn-more" class="nav-link nav-link-cta">Getting started</a>
            </li>
          </ul>
        </nav>

        <div class="header-controls">
          <a href="https://www.plcnext-community.net/?s=" target="_blank" class="search-toggle">
            <i class="icon-search"></i>
          </a>
          <a href="/u" class="user-toggle" title="User Menu">
            <i class="icon-user"></i>
          </a>
          <button class="mobile-menu-toggle" data-burger>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
          </button>
        </div>
      </div>
    </header>


    <!-- Mobile User Menu Overlay (Right) -->
    <div class="mobile-overlay" data-mobile-nav>
      <div class="mobile-nav-content">
        <nav class="mobile-navigation">
          <ul class="mobile-nav-menu">
            <li><a href="/u">My Account</a></li>
            <li><a href="/preferences">Preferences</a></li>
            <li><a href="/bookmarks">Bookmarks</a></li>
            <li><a href="/notifications">Notifications</a></li>
            <li><a href="/logout">Logout</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</template>

<script>
function insertPLCNextHeader() {
    const existingHeader = document.querySelector('[data-menu-wrapper]');
    if (existingHeader) existingHeader.remove();

    const template = document.getElementById('plcnext-header-template');
    if (!template) return;

    const headerContent = template.content.cloneNode(true);
    const body = document.body;

    if (body.firstChild) {
        body.insertBefore(headerContent, body.firstChild);
    } else {
        body.appendChild(headerContent);
    }

    initializePLCNextHeader();
}

function initializePLCNextHeader() {
    const menuWrapper = document.querySelector('[data-menu-wrapper]');
    if (!menuWrapper) return;

    const sidebarToggle = menuWrapper.querySelector('.btn-sidebar-toggle');
    const mobileMenuToggle = menuWrapper.querySelector('[data-burger]');
    const mobileOverlay = menuWrapper.querySelector('[data-mobile-nav]');

    // Discourse sidebar toggle functionality
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function(e) {
            e.preventDefault();

            // Try multiple methods to trigger Discourse sidebar
            // Method 1: Find and click existing Discourse sidebar toggle
            const discourseSidebarToggle = document.querySelector('.sidebar-toggle:not(.btn-sidebar-toggle)') ||
                                         document.querySelector('#toggle-hamburger-menu') ||
                                         document.querySelector('.hamburger-dropdown');

            if (discourseSidebarToggle) {
                discourseSidebarToggle.click();
                return;
            }

            // Method 2: Use Discourse's application controller if available
            if (window.Discourse && window.Discourse.__container__) {
                const appController = window.Discourse.__container__.lookup('controller:application');
                if (appController && appController.toggleHamburger) {
                    appController.toggleHamburger();
                    return;
                }
            }

            // Method 3: Dispatch Discourse-compatible events
            const hamburgerMenuEvent = new CustomEvent('click');
            const hamburgerMenu = document.querySelector('.hamburger-panel') ||
                                document.querySelector('#hamburger-menu');
            if (hamburgerMenu) {
                hamburgerMenu.dispatchEvent(hamburgerMenuEvent);
            }
        });
    }

    // Mobile user menu functionality (right side)
    if (mobileMenuToggle && mobileOverlay) {
        mobileMenuToggle.addEventListener('click', function(e) {
            e.preventDefault();
            const isActive = mobileOverlay.classList.contains('active');

            if (isActive) {
                mobileOverlay.classList.remove('active');
                mobileMenuToggle.classList.remove('active');
                document.body.style.overflow = '';
            } else {
                mobileOverlay.classList.add('active');
                mobileMenuToggle.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        });

        mobileOverlay.addEventListener('click', function(e) {
            if (e.target === mobileOverlay) {
                mobileOverlay.classList.remove('active');
                mobileMenuToggle.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    }

    window.addEventListener('resize', function() {
        if (window.innerWidth > 991) {
            if (mobileOverlay && mobileMenuToggle) {
                mobileOverlay.classList.remove('active');
                mobileMenuToggle.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', insertPLCNextHeader);
if (document.readyState !== 'loading') insertPLCNextHeader();

// Reinitialize on page changes for SPA
let lastUrl = location.href;
new MutationObserver(() => {
    const url = location.href;
    if (url !== lastUrl) {
        lastUrl = url;
        setTimeout(insertPLCNextHeader, 300);
    }
}).observe(document, { subtree: true, childList: true });
</script>

