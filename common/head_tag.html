<!-- UserCentrics Cookie Consent Management - Loaded dynamically to comply with CSP -->
<script>
(function() {
  const UC_DEBUG = true; // Set to false in production
  const UC_SETTINGS_ID = 'mf6q7MvbSbk-dj';

  function ucLog(msg, data) {
    if (UC_DEBUG) console.log('[UserCentrics]', msg, data || '');
  }

  function ucError(msg, error) {
    console.error('[UserCentrics ERROR]', msg, error || '');
  }

  // Add preconnect for performance
  const preconnect = document.createElement('link');
  preconnect.rel = 'preconnect';
  preconnect.href = 'https://privacy-proxy.usercentrics.eu';
  document.head.appendChild(preconnect);
  ucLog('Preconnect hinzugefügt');

  // Load UserCentrics CMP Loader with error handling
  const ucScript = document.createElement('script');
  ucScript.id = 'usercentrics-cmp';
  ucScript.src = 'https://app.usercentrics.eu/browser-ui/latest/loader.js';
  ucScript.setAttribute('data-settings-id', UC_SETTINGS_ID);
  ucScript.async = true;

  ucScript.addEventListener('load', function() {
    ucLog('CMP Loader erfolgreich geladen');

    // Wait for UC_UI to be available
    let attempts = 0;
    const maxAttempts = 50; // 5 seconds max
    const checkInterval = setInterval(function() {
      attempts++;

      if (typeof UC_UI !== 'undefined') {
        ucLog('✓ UC_UI ist verfügbar', { attempts: attempts, time: attempts * 100 + 'ms' });
        clearInterval(checkInterval);
        window.ucReady = true;
        window.dispatchEvent(new Event('uc-ready'));
      } else if (attempts >= maxAttempts) {
        ucError('UC_UI nicht verfügbar nach ' + (maxAttempts * 100) + 'ms');
        ucError('Mögliche Ursachen:', {
          settingsId: UC_SETTINGS_ID,
          domain: window.location.hostname,
          hinweis: 'Prüfe ob Domain in UserCentrics Dashboard whitelisted ist'
        });
        clearInterval(checkInterval);
      }
    }, 100);
  });

  ucScript.addEventListener('error', function(e) {
    ucError('CMP Loader konnte nicht geladen werden', e);
  });

  document.head.appendChild(ucScript);
  ucLog('CMP Loader Script eingefügt');

  // Load Smart Data Protector after CMP with error handling
  const ucBlockScript = document.createElement('script');
  ucBlockScript.type = 'application/javascript';
  ucBlockScript.src = 'https://privacy-proxy.usercentrics.eu/latest/uc-block.bundle.js';

  ucBlockScript.addEventListener('load', function() {
    ucLog('Smart Data Protector erfolgreich geladen');
  });

  ucBlockScript.addEventListener('error', function(e) {
    ucError('Smart Data Protector konnte nicht geladen werden', e);
  });

  document.head.appendChild(ucBlockScript);
  ucLog('Smart Data Protector Script eingefügt');

  // Settings validation (async)
  fetch('https://app.usercentrics.eu/latest/' + UC_SETTINGS_ID + '/settings.json')
    .then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(function(settings) {
      ucLog('✓ Settings erfolgreich geladen');
      ucLog('Konfigurierte Domains:', settings.domains || 'Keine Einschränkung');

      // Check if current domain is whitelisted
      if (settings.domains && settings.domains.length > 0) {
        const currentDomain = window.location.hostname;
        const isWhitelisted = settings.domains.some(function(d) {
          return currentDomain === d || currentDomain.endsWith('.' + d);
        });

        if (!isWhitelisted) {
          ucError('⚠ DOMAIN NICHT WHITELISTED!', {
            aktuelle: currentDomain,
            erlaubte: settings.domains,
            aktion: 'Domain in UserCentrics Dashboard hinzufügen!'
          });
        } else {
          ucLog('✓ Domain ist whitelisted');
        }
      }
    })
    .catch(function(e) {
      ucError('Settings konnten nicht geladen werden', e);
    });
})();
</script>

<!-- Page Meta - Must be loaded before GTM -->
<script>
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    event: "Page Meta",
    environment: "Production",
    system: "PLCnext Community Forum"
  });
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WGJF3694');</script>
<!-- End Google Tag Manager -->

<!-- PLCNext Community Header Theme -->
<meta name="theme-name" content="PLCNext Community Header Theme">
<meta name="theme-version" content="2.0.0">

<!-- PLCNext Navigation Template -->
<template id="plcnext-header-template">
  <nav class="main-navigation">
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="https://www.plcnext-community.net/infocenter/news" class="nav-link">News & Articles</a>
      </li>
      <li class="nav-item">
        <a href="https://www.plcnext-community.net/about-plcnext-technology" class="nav-link">About PLCnext Technology</a>
      </li>
      <li class="nav-item">
        <a href="https://www.plcnext-community.net/learning" class="nav-link">Learning</a>
      </li>
      <li class="nav-item">
        <a href="https://www.plcnext-community.net/makers-blog" class="nav-link">Maker's Blog</a>
      </li>
      <li class="nav-item">
        <a href="/" class="nav-link">Forum</a>
      </li>
      <li class="nav-item">
        <a href="https://www.plcnext-community.net/getting-started-with-plcnext-technology/#learn-more" class="nav-link nav-link-cta">Getting started</a>
      </li>
    </ul>
  </nav>
</template>

<!-- PLCNext Footer Template -->
<template id="plcnext-footer-template">
  <footer class="plcnext-footer" id="plcnext-footer">
    <div class="footer-container">
      <nav class="footer-navigation">
        <a href="https://www.plcnext-community.net/legalinformation/" class="footer-link">Legal information</a>
        <a href="https://www.phoenixcontact.com/en-pc/site-notice" class="footer-link">Site notice</a>
        <a href="https://www.phoenixcontact.com/en-pc/legal-information/data-privacy" class="footer-link">Data privacy</a>
        <a href="#" id="uc-privacy-settings" class="footer-link">Privacy Settings</a>
      </nav>
	    <div class="footer-logo">
		    <a href="https://www.phoenixcontact.com/en-pc/">
			    <img src="https://www.plcnext-community.net//app/themes/plcnextcommunity/static/images/logo-phoenix-contact.svg" alt="Phoenix Contact" class="footer-logo-image">
		    </a>
	    </div>
    </div>
  </footer>
</template>

<script>
function insertPLCNextHeader() {
    // Wait for Discourse header to be available
    const discourseHeader = document.querySelector('#site-header') || document.querySelector('.d-header');
    if (!discourseHeader) {
        setTimeout(insertPLCNextHeader, 500);
        return;
    }

    // Remove existing PLCNext modifications
    const existingPLCNext = discourseHeader.querySelector('.plcnext-navigation');
    if (existingPLCNext) existingPLCNext.remove();

    // Add PLCNext navigation with theme settings
    const template = document.getElementById('plcnext-header-template');
    if (!template) return;

    const headerContent = template.content.cloneNode(true);
    const plcnextNav = headerContent.querySelector('.main-navigation');

    if (plcnextNav) {
        plcnextNav.classList.add('plcnext-navigation');

        // Try different insertion points
        const headerContents = discourseHeader.querySelector('.contents') ||
                             discourseHeader.querySelector('.wrap') ||
                             discourseHeader;

        const insertionPoint = headerContents.querySelector('.panel') ||
                             headerContents.querySelector('.header-buttons') ||
                             headerContents.querySelector('.auth-buttons') ||
                             headerContents.lastElementChild;

        if (insertionPoint) {
            insertionPoint.parentNode.insertBefore(plcnextNav, insertionPoint);
        } else {
            headerContents.appendChild(plcnextNav);
        }
    }

    // Replace logo
    replaceLogo();

    // Insert footer
    insertPLCNextFooter();

    initializePLCNextHeader();
}

function replaceLogo() {
    // Find all possible logo elements
    const logoSelectors = [
        '#site-header .logo-mobile img',
        '#site-header .title a',
        '.d-header .logo-mobile img',
        '.d-header .title a',
        '#site-header .logo img',
        '.d-header .logo img'
    ];

    logoSelectors.forEach(selector => {
        const logoElements = document.querySelectorAll(selector);
        logoElements.forEach(element => {
            if (element.tagName === 'IMG') {
                element.src = 'https://www.plcnext-community.net/app/themes/plcnextcommunity/static/images/logo-plc-next.svg';
                element.alt = 'PLCnext Community';
                element.style.height = '45px';
                element.style.width = 'auto';
            } else if (element.tagName === 'A') {
                element.href = 'https://www.plcnext-community.net';

                // Check if it contains an img
                const img = element.querySelector('img');
                if (img) {
                    img.src = 'https://www.plcnext-community.net/app/themes/plcnextcommunity/static/images/logo-plc-next.svg';
                    img.alt = 'PLCnext Community';
                    img.style.height = '45px';
                    img.style.width = 'auto';
                }

                // If it's a text-based title, replace the text
                if (!img && element.textContent) {
                    element.innerHTML = '<img src="https://www.plcnext-community.net/app/themes/plcnextcommunity/static/images/logo-plc-next.svg" alt="PLCnext Community" style="height: 45px; width: auto;">';
                }
            }
        });
    });
}

function insertPLCNextFooter() {
    // Remove existing footer
    const existingFooter = document.querySelector('#plcnext-footer');
    if (existingFooter) existingFooter.remove();

    // Add PLCNext footer with theme settings
    const template = document.getElementById('plcnext-footer-template');
    if (!template) return;

    const footerContent = template.content.cloneNode(true);

    // Insert footer at the very end of the body, after all Discourse content
    document.body.appendChild(footerContent);

    // Add event listener for Privacy Settings link (CSP-compliant)
    // Wait for UserCentrics to be ready
    function setupPrivacyLink() {
        const privacyLink = document.getElementById('uc-privacy-settings');
        if (!privacyLink) return;

        privacyLink.addEventListener('click', function(e) {
            e.preventDefault();

            if (typeof UC_UI !== 'undefined' && UC_UI.showSecondLayer) {
                if (window.ucReady || typeof UC_UI !== 'undefined') {
                    console.log('[UserCentrics] Privacy Settings öffnen');
                    UC_UI.showSecondLayer();
                } else {
                    console.warn('[UserCentrics] UC_UI noch nicht bereit, warte...');
                    // Wait for UC to be ready
                    window.addEventListener('uc-ready', function() {
                        UC_UI.showSecondLayer();
                    }, { once: true });
                }
            } else {
                console.error('[UserCentrics] UC_UI.showSecondLayer nicht verfügbar!');
                alert('Cookie-Einstellungen können nicht geladen werden. Bitte Seite neu laden.');
            }
            return false;
        });
        console.log('[UserCentrics] Privacy Settings Link registriert');
    }

    // Setup immediately if UC is ready, otherwise wait
    if (window.ucReady) {
        setupPrivacyLink();
    } else {
        window.addEventListener('uc-ready', setupPrivacyLink, { once: true });
        // Fallback: Setup anyway after 2 seconds
        setTimeout(setupPrivacyLink, 2000);
    }
}


function initializePLCNextHeader() {
    // Since we're now using the original Discourse header, we don't need custom functionality
    // The hamburger menu and user menu will work automatically with Discourse's built-in functionality
}

// Initialize
document.addEventListener('DOMContentLoaded', insertPLCNextHeader);
if (document.readyState !== 'loading') insertPLCNextHeader();

// Reinitialize on page changes for SPA
let lastUrl = location.href;
new MutationObserver(() => {
    const url = location.href;
    if (url !== lastUrl) {
        lastUrl = url;
        setTimeout(insertPLCNextHeader, 300);
    }
}).observe(document, { subtree: true, childList: true });
</script>

